#!/usr/bin/env node

/* eslint no-console:0 */

'use strict';

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _liftoff = require('liftoff');

var _liftoff2 = _interopRequireDefault(_liftoff);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _interpret = require('interpret');

var _interpret2 = _interopRequireDefault(_interpret);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _tildify = require('tildify');

var _tildify2 = _interopRequireDefault(_tildify);

var _commander = require('commander');

var _commander2 = _interopRequireDefault(_commander);

var argv = require('minimist')(process.argv.slice(2));
var fs = _bluebird2['default'].promisifyAll(require('fs'));
var cliPkg = require('../../package');

function exit(text) {
  if (text instanceof Error) {
    _chalk2['default'].red(console.error(text.stack));
  } else {
    _chalk2['default'].red(console.error(text));
  }
  process.exit(1);
}

function success(text) {
  console.log(text);
  process.exit(0);
}

function checkLocalModule(env) {
  if (!env.modulePath) {
    console.log(_chalk2['default'].red('No local knex install found in:'), _chalk2['default'].magenta(_tildify2['default'](env.cwd)));
    exit('Try running: npm install knex.');
  }
}

function initKnex(env) {

  checkLocalModule(env);

  if (!env.configPath) {
    exit('No knexfile found in this directory. Specify a path with --knexfile');
  }

  if (process.cwd() !== env.cwd) {
    process.chdir(env.cwd);
    console.log('Working directory changed to', _chalk2['default'].magenta(_tildify2['default'](env.cwd)));
  }

  var environment = _commander2['default'].env || process.env.NODE_ENV;
  var defaultEnv = 'development';
  var config = require(env.configPath);

  if (!environment && typeof config[defaultEnv] === 'object') {
    environment = defaultEnv;
  }

  if (environment) {
    console.log('Using environment:', _chalk2['default'].magenta(environment));
    config = config[environment] || config;
  }

  if (!config) {
    console.log(_chalk2['default'].red('Warning: unable to read knexfile config'));
    process.exit(1);
  }

  if (argv.debug !== undefined) config.debug = argv.debug;
  var knex = require(env.modulePath);
  return knex(config);
}

function invoke(env) {

  var filetypes = ['js', 'coffee', 'eg', 'ls'];
  var pending = null;

  _commander2['default'].version(_chalk2['default'].blue('Knex CLI version: ', _chalk2['default'].green(cliPkg.version)) + '\n' + _chalk2['default'].blue('Local Knex version: ', _chalk2['default'].green(env.modulePackage.version)) + '\n').option('--debug', 'Run with debugging.').option('--knexfile [path]', 'Specify the knexfile path.').option('--cwd [path]', 'Specify the working directory.').option('--env [name]', 'environment, default: process.env.NODE_ENV || development');

  _commander2['default'].command('init').description('        Create a fresh knexfile.').option('-x [' + filetypes.join('|') + ']', 'Specify the knexfile extension (default js)').action(function () {
    var type = (argv.x || 'js').toLowerCase();
    if (filetypes.indexOf(type) === -1) {
      exit('Invalid filetype specified: ' + type);
    }
    if (env.configPath) {
      exit('Error: ' + env.configPath + ' already exists');
    }
    checkLocalModule(env);
    var stubPath = './knexfile.' + type;
    pending = fs.readFileAsync(_path2['default'].dirname(env.modulePath) + '/lib/migrate/stub/knexfile-' + type + '.stub').then(function (code) {
      return fs.writeFileAsync(stubPath, code);
    }).then(function () {
      success(_chalk2['default'].green('Created ' + stubPath));
    })['catch'](exit);
  });

  _commander2['default'].command('migrate:make <name>').description('       Create a named migration file.').option('-x [' + filetypes.join('|') + ']', 'Specify the stub extension (default js)').action(function (name) {
    var instance = initKnex(env);
    var ext = (argv.x || env.configPath.split('.').pop()).toLowerCase();
    pending = instance.migrate.make(name, { extension: ext }).then(function (name) {
      success(_chalk2['default'].green('Created Migration: ' + name));
    })['catch'](exit);
  });

  _commander2['default'].command('migrate:latest').description('        Run all migrations that have not yet been run.').action(function () {
    pending = initKnex(env).migrate.latest().spread(function (batchNo, log) {
      if (log.length === 0) {
        success(_chalk2['default'].cyan('Already up to date'));
      }
      success(_chalk2['default'].green('Batch ' + batchNo + ' run: ' + log.length + ' migrations \n') + _chalk2['default'].cyan(log.join('\n')));
    })['catch'](exit);
  });

  _commander2['default'].command('migrate:rollback').description('        Rollback the last set of migrations performed.').action(function () {
    pending = initKnex(env).migrate.rollback().spread(function (batchNo, log) {
      if (log.length === 0) {
        success(_chalk2['default'].cyan('Already at the base migration'));
      }
      success(_chalk2['default'].green('Batch ' + batchNo + ' rolled back: ' + log.length + ' migrations \n') + _chalk2['default'].cyan(log.join('\n')));
    })['catch'](exit);
  });

  _commander2['default'].command('migrate:currentVersion').description('       View the current version for the migration.').action(function () {
    pending = initKnex(env).migrate.currentVersion().then(function (version) {
      success(_chalk2['default'].green('Current Version: ') + _chalk2['default'].blue(version));
    })['catch'](exit);
  });

  _commander2['default'].command('schema:dump').description('       Dump the current database schema.').action(function () {
    pending = initKnex(env).schemaLoader.dump().then(function () {
      success(_chalk2['default'].green('Dumped schema successfully'));
    })['catch'](exit);
  });

  _commander2['default'].command('schema:load').description('       Load the schema into the database.').action(function () {
    pending = initKnex(env).schemaLoader.load().then(function () {
      success(_chalk2['default'].green('Loaded schema successfully'));
    })['catch'](exit);
  });

  _commander2['default'].command('schema:drop').description('       Drop the current database schema.').action(function () {
    pending = initKnex(env).schemaLoader.drop().then(function () {
      success(_chalk2['default'].green('Dropped schema successfully'));
    })['catch'](exit);
  });

  _commander2['default'].command('schema:create').description('       Create the current database schema.').action(function () {
    pending = initKnex(env).schemaLoader.create().then(function () {
      success(_chalk2['default'].green('Created schema successfully'));
    })['catch'](exit);
  });

  _commander2['default'].command('schema:reset').description('       Reset the current database schema (drop, create, load).').action(function () {
    pending = initKnex(env).schemaLoader.reset().then(function () {
      success(_chalk2['default'].green('Schema reset successfully'));
    })['catch'](exit);
  });

  _commander2['default'].command('seed:make <name>').description('       Create a named seed file.').option('-x [' + filetypes.join('|') + ']', 'Specify the stub extension (default js)').action(function (name) {
    var instance = initKnex(env);
    var ext = (argv.x || env.configPath.split('.').pop()).toLowerCase();
    pending = instance.seed.make(name, { extension: ext }).then(function (name) {
      success(_chalk2['default'].green('Created seed file: ' + name));
    })['catch'](exit);
  });

  _commander2['default'].command('seed:run').description('       Run seed files.').action(function () {
    pending = initKnex(env).seed.run().spread(function (log) {
      if (log.length === 0) {
        success(_chalk2['default'].cyan('No seed files exist'));
      }
      success(_chalk2['default'].green('Ran ' + log.length + ' seed files \n' + _chalk2['default'].cyan(log.join('\n'))));
    })['catch'](exit);
  });

  _commander2['default'].parse(process.argv);

  _bluebird2['default'].resolve(pending).then(function () {
    _commander2['default'].help();
  });
}

var cli = new _liftoff2['default']({
  name: 'knex',
  extensions: _interpret2['default'].jsVariants,
  v8flags: require('v8flags')
});

cli.on('require', function (name) {
  console.log('Requiring external module', _chalk2['default'].magenta(name));
});

cli.on('requireFail', function (name) {
  console.log(_chalk2['default'].red('Failed to load external module'), _chalk2['default'].magenta(name));
});

cli.launch({
  cwd: argv.cwd,
  configPath: argv.knexfile,
  require: argv.require,
  completion: argv.completion
}, invoke);
//# sourceMappingURL=data:application/json;base64,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QyxHQUFHO0FBQ2IsWUFBVSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3pCLFNBQU8sRUFBRSxJQUFJLENBQUMsT0FBTztBQUNyQixZQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7Q0FDNUIsRUFBRSxNQUFNLENBQUMsQ0FBQyIsImZpbGUiOiJjbGkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8qIGVzbGludCBuby1jb25zb2xlOjAgKi9cblxuaW1wb3J0IExpZnRvZmYgZnJvbSAnbGlmdG9mZic7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgaW50ZXJwcmV0IGZyb20gJ2ludGVycHJldCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgdGlsZGlmeSBmcm9tICd0aWxkaWZ5JztcbmltcG9ydCBjb21tYW5kZXIgZnJvbSAnY29tbWFuZGVyJztcbmNvbnN0IGFyZ3YgPSByZXF1aXJlKCdtaW5pbWlzdCcpKHByb2Nlc3MuYXJndi5zbGljZSgyKSk7XG5jb25zdCBmcyA9IFByb21pc2UucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ2ZzJykpO1xuY29uc3QgY2xpUGtnID0gcmVxdWlyZSgnLi4vLi4vcGFja2FnZScpO1xuXG5mdW5jdGlvbiBleGl0KHRleHQpIHtcbiAgaWYgKHRleHQgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIGNoYWxrLnJlZChjb25zb2xlLmVycm9yKHRleHQuc3RhY2spKTtcbiAgfSBlbHNlIHtcbiAgICBjaGFsay5yZWQoY29uc29sZS5lcnJvcih0ZXh0KSk7XG4gIH1cbiAgcHJvY2Vzcy5leGl0KDEpO1xufVxuXG5mdW5jdGlvbiBzdWNjZXNzKHRleHQpIHtcbiAgY29uc29sZS5sb2codGV4dCk7XG4gIHByb2Nlc3MuZXhpdCgwKTtcbn1cblxuZnVuY3Rpb24gY2hlY2tMb2NhbE1vZHVsZShlbnYpIHtcbiAgaWYgKCFlbnYubW9kdWxlUGF0aCkge1xuICAgIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgnTm8gbG9jYWwga25leCBpbnN0YWxsIGZvdW5kIGluOicpLCBjaGFsay5tYWdlbnRhKHRpbGRpZnkoZW52LmN3ZCkpKTtcbiAgICBleGl0KCdUcnkgcnVubmluZzogbnBtIGluc3RhbGwga25leC4nKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpbml0S25leChlbnYpIHtcblxuICBjaGVja0xvY2FsTW9kdWxlKGVudik7XG5cbiAgaWYgKCFlbnYuY29uZmlnUGF0aCkge1xuICAgIGV4aXQoJ05vIGtuZXhmaWxlIGZvdW5kIGluIHRoaXMgZGlyZWN0b3J5LiBTcGVjaWZ5IGEgcGF0aCB3aXRoIC0ta25leGZpbGUnKTtcbiAgfVxuXG4gIGlmIChwcm9jZXNzLmN3ZCgpICE9PSBlbnYuY3dkKSB7XG4gICAgcHJvY2Vzcy5jaGRpcihlbnYuY3dkKTtcbiAgICBjb25zb2xlLmxvZygnV29ya2luZyBkaXJlY3RvcnkgY2hhbmdlZCB0bycsIGNoYWxrLm1hZ2VudGEodGlsZGlmeShlbnYuY3dkKSkpO1xuICB9XG5cbiAgbGV0IGVudmlyb25tZW50ID0gY29tbWFuZGVyLmVudiB8fCBwcm9jZXNzLmVudi5OT0RFX0VOVjtcbiAgY29uc3QgZGVmYXVsdEVudiA9ICdkZXZlbG9wbWVudCc7XG4gIGxldCBjb25maWcgPSByZXF1aXJlKGVudi5jb25maWdQYXRoKTtcblxuICBpZiAoIWVudmlyb25tZW50ICYmIHR5cGVvZiBjb25maWdbZGVmYXVsdEVudl0gPT09ICdvYmplY3QnKSB7XG4gICAgZW52aXJvbm1lbnQgPSBkZWZhdWx0RW52O1xuICB9XG5cbiAgaWYgKGVudmlyb25tZW50KSB7XG4gICAgY29uc29sZS5sb2coJ1VzaW5nIGVudmlyb25tZW50OicsIGNoYWxrLm1hZ2VudGEoZW52aXJvbm1lbnQpKTtcbiAgICBjb25maWcgPSBjb25maWdbZW52aXJvbm1lbnRdIHx8IGNvbmZpZztcbiAgfVxuXG4gIGlmICghY29uZmlnKSB7XG4gICAgY29uc29sZS5sb2coY2hhbGsucmVkKCdXYXJuaW5nOiB1bmFibGUgdG8gcmVhZCBrbmV4ZmlsZSBjb25maWcnKSk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG5cbiAgaWYgKGFyZ3YuZGVidWcgIT09IHVuZGVmaW5lZClcbiAgICBjb25maWcuZGVidWcgPSBhcmd2LmRlYnVnO1xuICBjb25zdCBrbmV4ID0gcmVxdWlyZShlbnYubW9kdWxlUGF0aCk7XG4gIHJldHVybiBrbmV4KGNvbmZpZyk7XG59XG5cbmZ1bmN0aW9uIGludm9rZShlbnYpIHtcblxuICBjb25zdCBmaWxldHlwZXMgPSBbJ2pzJywgJ2NvZmZlZScsICdlZycsICdscyddO1xuICBsZXQgcGVuZGluZyA9IG51bGw7XG5cbiAgY29tbWFuZGVyXG4gICAgLnZlcnNpb24oXG4gICAgICBjaGFsay5ibHVlKCdLbmV4IENMSSB2ZXJzaW9uOiAnLCBjaGFsay5ncmVlbihjbGlQa2cudmVyc2lvbikpICsgJ1xcbicgK1xuICAgICAgY2hhbGsuYmx1ZSgnTG9jYWwgS25leCB2ZXJzaW9uOiAnLCBjaGFsay5ncmVlbihlbnYubW9kdWxlUGFja2FnZS52ZXJzaW9uKSkgKyAnXFxuJ1xuICAgIClcbiAgICAub3B0aW9uKCctLWRlYnVnJywgJ1J1biB3aXRoIGRlYnVnZ2luZy4nKVxuICAgIC5vcHRpb24oJy0ta25leGZpbGUgW3BhdGhdJywgJ1NwZWNpZnkgdGhlIGtuZXhmaWxlIHBhdGguJylcbiAgICAub3B0aW9uKCctLWN3ZCBbcGF0aF0nLCAnU3BlY2lmeSB0aGUgd29ya2luZyBkaXJlY3RvcnkuJylcbiAgICAub3B0aW9uKCctLWVudiBbbmFtZV0nLCAnZW52aXJvbm1lbnQsIGRlZmF1bHQ6IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8IGRldmVsb3BtZW50Jyk7XG5cblxuICBjb21tYW5kZXJcbiAgICAuY29tbWFuZCgnaW5pdCcpXG4gICAgLmRlc2NyaXB0aW9uKCcgICAgICAgIENyZWF0ZSBhIGZyZXNoIGtuZXhmaWxlLicpXG4gICAgLm9wdGlvbihgLXggWyR7ZmlsZXR5cGVzLmpvaW4oJ3wnKX1dYCwgJ1NwZWNpZnkgdGhlIGtuZXhmaWxlIGV4dGVuc2lvbiAoZGVmYXVsdCBqcyknKVxuICAgIC5hY3Rpb24oZnVuY3Rpb24oKSB7XG4gICAgICBjb25zdCB0eXBlID0gKGFyZ3YueCB8fCAnanMnKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKGZpbGV0eXBlcy5pbmRleE9mKHR5cGUpID09PSAtMSkge1xuICAgICAgICBleGl0KGBJbnZhbGlkIGZpbGV0eXBlIHNwZWNpZmllZDogJHt0eXBlfWApO1xuICAgICAgfVxuICAgICAgaWYgKGVudi5jb25maWdQYXRoKSB7XG4gICAgICAgIGV4aXQoYEVycm9yOiAke2Vudi5jb25maWdQYXRofSBhbHJlYWR5IGV4aXN0c2ApO1xuICAgICAgfVxuICAgICAgY2hlY2tMb2NhbE1vZHVsZShlbnYpO1xuICAgICAgY29uc3Qgc3R1YlBhdGggPSBgLi9rbmV4ZmlsZS4ke3R5cGV9YDtcbiAgICAgIHBlbmRpbmcgPSBmcy5yZWFkRmlsZUFzeW5jKFxuICAgICAgICBwYXRoLmRpcm5hbWUoZW52Lm1vZHVsZVBhdGgpICtcbiAgICAgICAgJy9saWIvbWlncmF0ZS9zdHViL2tuZXhmaWxlLScgK1xuICAgICAgICB0eXBlICsgJy5zdHViJ1xuICAgICAgKS50aGVuKGNvZGUgPT4gZnMud3JpdGVGaWxlQXN5bmMoc3R1YlBhdGgsIGNvZGUpKS50aGVuKCgpID0+IHtcbiAgICAgICAgc3VjY2VzcyhjaGFsay5ncmVlbihgQ3JlYXRlZCAke3N0dWJQYXRofWApKTtcbiAgICAgIH0pLmNhdGNoKGV4aXQpO1xuICAgIH0pO1xuXG4gIGNvbW1hbmRlclxuICAgIC5jb21tYW5kKCdtaWdyYXRlOm1ha2UgPG5hbWU+JylcbiAgICAuZGVzY3JpcHRpb24oJyAgICAgICBDcmVhdGUgYSBuYW1lZCBtaWdyYXRpb24gZmlsZS4nKVxuICAgIC5vcHRpb24oYC14IFske2ZpbGV0eXBlcy5qb2luKCd8Jyl9XWAsICdTcGVjaWZ5IHRoZSBzdHViIGV4dGVuc2lvbiAoZGVmYXVsdCBqcyknKVxuICAgIC5hY3Rpb24oZnVuY3Rpb24obmFtZSkge1xuICAgICAgY29uc3QgaW5zdGFuY2UgPSBpbml0S25leChlbnYpO1xuICAgICAgY29uc3QgZXh0ID0gKGFyZ3YueCB8fCBlbnYuY29uZmlnUGF0aC5zcGxpdCgnLicpLnBvcCgpKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgcGVuZGluZyA9IGluc3RhbmNlLm1pZ3JhdGUubWFrZShuYW1lLCB7ZXh0ZW5zaW9uOiBleHR9KS50aGVuKGZ1bmN0aW9uKG5hbWUpIHtcbiAgICAgICAgc3VjY2VzcyhjaGFsay5ncmVlbihgQ3JlYXRlZCBNaWdyYXRpb246ICR7bmFtZX1gKSk7XG4gICAgICB9KS5jYXRjaChleGl0KTtcbiAgICB9KTtcblxuICBjb21tYW5kZXJcbiAgICAuY29tbWFuZCgnbWlncmF0ZTpsYXRlc3QnKVxuICAgIC5kZXNjcmlwdGlvbignICAgICAgICBSdW4gYWxsIG1pZ3JhdGlvbnMgdGhhdCBoYXZlIG5vdCB5ZXQgYmVlbiBydW4uJylcbiAgICAuYWN0aW9uKGZ1bmN0aW9uKCkge1xuICAgICAgcGVuZGluZyA9IGluaXRLbmV4KGVudikubWlncmF0ZS5sYXRlc3QoKS5zcHJlYWQoZnVuY3Rpb24oYmF0Y2hObywgbG9nKSB7XG4gICAgICAgIGlmIChsb2cubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgc3VjY2VzcyhjaGFsay5jeWFuKCdBbHJlYWR5IHVwIHRvIGRhdGUnKSk7XG4gICAgICAgIH1cbiAgICAgICAgc3VjY2VzcyhcbiAgICAgICAgICBjaGFsay5ncmVlbihgQmF0Y2ggJHtiYXRjaE5vfSBydW46ICR7bG9nLmxlbmd0aH0gbWlncmF0aW9ucyBcXG5gKSArXG4gICAgICAgICAgY2hhbGsuY3lhbihsb2cuam9pbignXFxuJykpXG4gICAgICAgICk7XG4gICAgICB9KS5jYXRjaChleGl0KTtcbiAgICB9KTtcblxuICBjb21tYW5kZXJcbiAgICAuY29tbWFuZCgnbWlncmF0ZTpyb2xsYmFjaycpXG4gICAgLmRlc2NyaXB0aW9uKCcgICAgICAgIFJvbGxiYWNrIHRoZSBsYXN0IHNldCBvZiBtaWdyYXRpb25zIHBlcmZvcm1lZC4nKVxuICAgIC5hY3Rpb24oZnVuY3Rpb24oKSB7XG4gICAgICBwZW5kaW5nID0gaW5pdEtuZXgoZW52KS5taWdyYXRlLnJvbGxiYWNrKCkuc3ByZWFkKGZ1bmN0aW9uKGJhdGNoTm8sIGxvZykge1xuICAgICAgICBpZiAobG9nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHN1Y2Nlc3MoY2hhbGsuY3lhbignQWxyZWFkeSBhdCB0aGUgYmFzZSBtaWdyYXRpb24nKSk7XG4gICAgICAgIH1cbiAgICAgICAgc3VjY2VzcyhcbiAgICAgICAgICBjaGFsay5ncmVlbihgQmF0Y2ggJHtiYXRjaE5vfSByb2xsZWQgYmFjazogJHtsb2cubGVuZ3RofSBtaWdyYXRpb25zIFxcbmApICtcbiAgICAgICAgICBjaGFsay5jeWFuKGxvZy5qb2luKCdcXG4nKSlcbiAgICAgICAgKTtcbiAgICAgIH0pLmNhdGNoKGV4aXQpO1xuICAgIH0pO1xuXG4gIGNvbW1hbmRlclxuICAgIC5jb21tYW5kKCdtaWdyYXRlOmN1cnJlbnRWZXJzaW9uJylcbiAgICAuZGVzY3JpcHRpb24oJyAgICAgICBWaWV3IHRoZSBjdXJyZW50IHZlcnNpb24gZm9yIHRoZSBtaWdyYXRpb24uJylcbiAgICAuYWN0aW9uKGZ1bmN0aW9uICgpIHtcbiAgICAgIHBlbmRpbmcgPSBpbml0S25leChlbnYpLm1pZ3JhdGUuY3VycmVudFZlcnNpb24oKS50aGVuKGZ1bmN0aW9uKHZlcnNpb24pIHtcbiAgICAgICAgc3VjY2VzcyhjaGFsay5ncmVlbignQ3VycmVudCBWZXJzaW9uOiAnKSArIGNoYWxrLmJsdWUodmVyc2lvbikpO1xuICAgICAgfSkuY2F0Y2goZXhpdCk7XG4gICAgfSk7XG5cbiAgY29tbWFuZGVyXG4gICAgLmNvbW1hbmQoJ3NjaGVtYTpkdW1wJylcbiAgICAuZGVzY3JpcHRpb24oJyAgICAgICBEdW1wIHRoZSBjdXJyZW50IGRhdGFiYXNlIHNjaGVtYS4nKVxuICAgIC5hY3Rpb24oZnVuY3Rpb24oKSB7XG4gICAgICBwZW5kaW5nID0gaW5pdEtuZXgoZW52KS5zY2hlbWFMb2FkZXIuZHVtcCgpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIHN1Y2Nlc3MoY2hhbGsuZ3JlZW4oJ0R1bXBlZCBzY2hlbWEgc3VjY2Vzc2Z1bGx5JykpO1xuICAgICAgfSkuY2F0Y2goZXhpdCk7XG4gICAgfSk7XG5cbiAgY29tbWFuZGVyXG4gICAgLmNvbW1hbmQoJ3NjaGVtYTpsb2FkJylcbiAgICAuZGVzY3JpcHRpb24oJyAgICAgICBMb2FkIHRoZSBzY2hlbWEgaW50byB0aGUgZGF0YWJhc2UuJylcbiAgICAuYWN0aW9uKGZ1bmN0aW9uKCkge1xuICAgICAgcGVuZGluZyA9IGluaXRLbmV4KGVudikuc2NoZW1hTG9hZGVyLmxvYWQoKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICBzdWNjZXNzKGNoYWxrLmdyZWVuKCdMb2FkZWQgc2NoZW1hIHN1Y2Nlc3NmdWxseScpKTtcbiAgICAgIH0pLmNhdGNoKGV4aXQpO1xuICAgIH0pO1xuXG4gIGNvbW1hbmRlclxuICAgIC5jb21tYW5kKCdzY2hlbWE6ZHJvcCcpXG4gICAgLmRlc2NyaXB0aW9uKCcgICAgICAgRHJvcCB0aGUgY3VycmVudCBkYXRhYmFzZSBzY2hlbWEuJylcbiAgICAuYWN0aW9uKGZ1bmN0aW9uKCkge1xuICAgICAgcGVuZGluZyA9IGluaXRLbmV4KGVudikuc2NoZW1hTG9hZGVyLmRyb3AoKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICBzdWNjZXNzKGNoYWxrLmdyZWVuKCdEcm9wcGVkIHNjaGVtYSBzdWNjZXNzZnVsbHknKSk7XG4gICAgICB9KS5jYXRjaChleGl0KTtcbiAgICB9KTtcblxuICBjb21tYW5kZXJcbiAgICAuY29tbWFuZCgnc2NoZW1hOmNyZWF0ZScpXG4gICAgLmRlc2NyaXB0aW9uKCcgICAgICAgQ3JlYXRlIHRoZSBjdXJyZW50IGRhdGFiYXNlIHNjaGVtYS4nKVxuICAgIC5hY3Rpb24oZnVuY3Rpb24oKSB7XG4gICAgICBwZW5kaW5nID0gaW5pdEtuZXgoZW52KS5zY2hlbWFMb2FkZXIuY3JlYXRlKCkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgc3VjY2VzcyhjaGFsay5ncmVlbignQ3JlYXRlZCBzY2hlbWEgc3VjY2Vzc2Z1bGx5JykpO1xuICAgICAgfSkuY2F0Y2goZXhpdCk7XG4gICAgfSk7XG5cbiAgY29tbWFuZGVyXG4gICAgLmNvbW1hbmQoJ3NjaGVtYTpyZXNldCcpXG4gICAgLmRlc2NyaXB0aW9uKCcgICAgICAgUmVzZXQgdGhlIGN1cnJlbnQgZGF0YWJhc2Ugc2NoZW1hIChkcm9wLCBjcmVhdGUsIGxvYWQpLicpXG4gICAgLmFjdGlvbihmdW5jdGlvbigpIHtcbiAgICAgIHBlbmRpbmcgPSBpbml0S25leChlbnYpLnNjaGVtYUxvYWRlci5yZXNldCgpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIHN1Y2Nlc3MoY2hhbGsuZ3JlZW4oJ1NjaGVtYSByZXNldCBzdWNjZXNzZnVsbHknKSk7XG4gICAgICB9KS5jYXRjaChleGl0KTtcbiAgICB9KTtcblxuICBjb21tYW5kZXJcbiAgICAuY29tbWFuZCgnc2VlZDptYWtlIDxuYW1lPicpXG4gICAgLmRlc2NyaXB0aW9uKCcgICAgICAgQ3JlYXRlIGEgbmFtZWQgc2VlZCBmaWxlLicpXG4gICAgLm9wdGlvbihgLXggWyR7ZmlsZXR5cGVzLmpvaW4oJ3wnKX1dYCwgJ1NwZWNpZnkgdGhlIHN0dWIgZXh0ZW5zaW9uIChkZWZhdWx0IGpzKScpXG4gICAgLmFjdGlvbihmdW5jdGlvbihuYW1lKSB7XG4gICAgICBjb25zdCBpbnN0YW5jZSA9IGluaXRLbmV4KGVudik7XG4gICAgICBjb25zdCBleHQgPSAoYXJndi54IHx8IGVudi5jb25maWdQYXRoLnNwbGl0KCcuJykucG9wKCkpLnRvTG93ZXJDYXNlKCk7XG4gICAgICBwZW5kaW5nID0gaW5zdGFuY2Uuc2VlZC5tYWtlKG5hbWUsIHtleHRlbnNpb246IGV4dH0pLnRoZW4oZnVuY3Rpb24obmFtZSkge1xuICAgICAgICBzdWNjZXNzKGNoYWxrLmdyZWVuKGBDcmVhdGVkIHNlZWQgZmlsZTogJHtuYW1lfWApKTtcbiAgICAgIH0pLmNhdGNoKGV4aXQpO1xuICAgIH0pO1xuXG4gIGNvbW1hbmRlclxuICAgIC5jb21tYW5kKCdzZWVkOnJ1bicpXG4gICAgLmRlc2NyaXB0aW9uKCcgICAgICAgUnVuIHNlZWQgZmlsZXMuJylcbiAgICAuYWN0aW9uKGZ1bmN0aW9uKCkge1xuICAgICAgcGVuZGluZyA9IGluaXRLbmV4KGVudikuc2VlZC5ydW4oKS5zcHJlYWQoZnVuY3Rpb24obG9nKSB7XG4gICAgICAgIGlmIChsb2cubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgc3VjY2VzcyhjaGFsay5jeWFuKCdObyBzZWVkIGZpbGVzIGV4aXN0JykpO1xuICAgICAgICB9XG4gICAgICAgIHN1Y2Nlc3MoY2hhbGsuZ3JlZW4oYFJhbiAke2xvZy5sZW5ndGh9IHNlZWQgZmlsZXMgXFxuJHtjaGFsay5jeWFuKGxvZy5qb2luKCdcXG4nKSl9YCkpO1xuICAgICAgfSkuY2F0Y2goZXhpdCk7XG4gICAgfSk7XG5cbiAgY29tbWFuZGVyLnBhcnNlKHByb2Nlc3MuYXJndik7XG5cbiAgUHJvbWlzZS5yZXNvbHZlKHBlbmRpbmcpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgY29tbWFuZGVyLmhlbHAoKTtcbiAgfSk7XG59XG5cbmNvbnN0IGNsaSA9IG5ldyBMaWZ0b2ZmKHtcbiAgbmFtZTogJ2tuZXgnLFxuICBleHRlbnNpb25zOiBpbnRlcnByZXQuanNWYXJpYW50cyxcbiAgdjhmbGFnczogcmVxdWlyZSgndjhmbGFncycpXG59KTtcblxuY2xpLm9uKCdyZXF1aXJlJywgZnVuY3Rpb24obmFtZSkge1xuICBjb25zb2xlLmxvZygnUmVxdWlyaW5nIGV4dGVybmFsIG1vZHVsZScsIGNoYWxrLm1hZ2VudGEobmFtZSkpO1xufSk7XG5cbmNsaS5vbigncmVxdWlyZUZhaWwnLCBmdW5jdGlvbihuYW1lKSB7XG4gIGNvbnNvbGUubG9nKGNoYWxrLnJlZCgnRmFpbGVkIHRvIGxvYWQgZXh0ZXJuYWwgbW9kdWxlJyksIGNoYWxrLm1hZ2VudGEobmFtZSkpO1xufSk7XG5cbmNsaS5sYXVuY2goe1xuICBjd2Q6IGFyZ3YuY3dkLFxuICBjb25maWdQYXRoOiBhcmd2LmtuZXhmaWxlLFxuICByZXF1aXJlOiBhcmd2LnJlcXVpcmUsXG4gIGNvbXBsZXRpb246IGFyZ3YuY29tcGxldGlvblxufSwgaW52b2tlKTtcbiJdfQ==